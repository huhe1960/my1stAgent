# 技术架构详解

## 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     用户交互层                            │
│                    (main.py)                            │
│  - 接收用户输入                                          │
│  - 显示Agent回复                                         │
│  - 管理对话循环                                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                    Agent核心层                           │
│                   (agent.py)                            │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 对话管理                                          │  │
│  │ - 维护对话历史                                    │  │
│  │ - 管理消息流转                                    │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 工具调用决策                                      │  │
│  │ - 解析LLM响应                                     │  │
│  │ - 判断是否需要调用工具                            │  │
│  │ - 执行工具并整合结果                              │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 迭代控制                                          │  │
│  │ - 控制最大迭代次数                                │  │
│  │ - 防止无限循环                                    │  │
│  └──────────────────────────────────────────────────┘  │
└────────────┬───────────────────────────┬────────────────┘
             │                           │
             ▼                           ▼
┌──────────────────────┐    ┌──────────────────────────┐
│   LLM客户端层         │    │      工具系统层           │
│  (llm_client.py)     │    │     (tools.py)           │
│                      │    │                          │
│  - API请求封装        │    │  - 工具函数定义          │
│  - 响应解析          │    │  - 工具Schema定义        │
│  - 错误处理          │    │  - 工具执行逻辑          │
│  - 支持tool calling  │    │  - 工具结果返回          │
└──────────┬───────────┘    └──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────┐
│              本地大模型API服务                           │
│        (DeepSeek/Qwen等，运行在localhost:8000)          │
│                                                         │
│  - 接收标准OpenAI格式请求                               │
│  - 返回模型推理结果                                     │
│  - 支持function calling                                 │
└─────────────────────────────────────────────────────────┘
```

## 数据流

### 1. 用户输入流程

```
用户输入
  ↓
main.py: 接收输入
  ↓
agent.py: chat()方法
  ↓
构建消息历史（包含系统提示）
  ↓
llm_client.py: chat_with_tools()
  ↓
发送HTTP请求到本地API
  ↓
本地大模型API处理
  ↓
返回响应（可能包含tool_calls）
```

### 2. 工具调用流程

```
LLM响应包含tool_calls
  ↓
agent.py: process_tool_calls()
  ↓
解析工具名称和参数
  ↓
tools.py: execute_tool()
  ↓
执行具体工具函数
  ↓
返回工具执行结果
  ↓
将结果添加到对话历史
  ↓
再次调用LLM（包含工具结果）
  ↓
LLM基于工具结果生成最终回复
```

### 3. 消息格式

#### 系统消息
```json
{
  "role": "system",
  "content": "你是一个有用的AI助手..."
}
```

#### 用户消息
```json
{
  "role": "user",
  "content": "帮我计算 123 + 456"
}
```

#### 助手消息（带工具调用）
```json
{
  "role": "assistant",
  "content": "",
  "tool_calls": [
    {
      "id": "call_123",
      "type": "function",
      "function": {
        "name": "calculator",
        "arguments": "{\"expression\": \"123 + 456\"}"
      }
    }
  ]
}
```

#### 工具结果消息
```json
{
  "role": "tool",
  "content": "579",
  "tool_call_id": "call_123"
}
```

## 关键技术点

### 1. Tool Calling机制

- **工具定义**: 使用OpenAI标准的function calling格式
- **工具描述**: 通过description和parameters帮助LLM理解工具用途
- **参数解析**: JSON格式的参数需要正确解析
- **结果整合**: 工具执行结果需要正确关联到对应的tool_call_id

### 2. 迭代执行

Agent采用迭代方式工作：
1. 第一轮：LLM分析问题，决定调用工具
2. 第二轮：执行工具，将结果返回给LLM
3. 第三轮：LLM基于工具结果生成最终答案

### 3. 对话历史管理

- 维护完整的对话上下文
- 包含系统提示、用户消息、助手消息、工具结果
- 每次LLM调用都包含完整历史，保证上下文连贯

### 4. 错误处理

- API请求失败处理
- 工具执行异常处理
- 最大迭代次数限制（防止死循环）

## 扩展方向

1. **更多工具**: 在tools.py中添加新工具函数
2. **记忆系统**: 添加长期记忆存储
3. **多Agent协作**: 实现多个Agent协同工作
4. **流式输出**: 支持实时流式响应
5. **插件系统**: 动态加载工具插件

